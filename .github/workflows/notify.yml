# ============================================================
# File: .github/workflows/notify.yml
# Project: GSoC 2026 PoC â€” GitHub Actions Ã— Discord Integration
# Author: NOAH DCRUZE
# Description:
#   Triggers on every push to any branch and sends a
#   "Hello World" notification to a Discord channel via
#   webhook. The committer's GitHub username and commit
#   message are included in the embed for context.
# ============================================================

name: ğŸ”” Discord Push Notification

# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches:
      - "**"   # Listen on ALL branches

# â”€â”€ Jobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  notify-discord:
    name: Send Hello World to Discord
    runs-on: ubuntu-latest

    steps:
      # Step 1 â€” Check out the code so we can read git metadata
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # Step 2 â€” Build and send the Discord webhook payload
      #
      # We use a Python one-liner so the JSON is easy to
      # read and extend. The webhook URL is pulled from
      # GitHub Secrets â€” it is NEVER hard-coded here.
      #
      # Context variables used:
      #   github.actor        â†’ GitHub username of the pusher
      #   github.event.head_commit.message â†’ latest commit msg
      #   github.repository   â†’ "owner/repo" string
      #   github.ref_name     â†’ branch name
      #   github.sha          â†’ full commit SHA
      - name: ğŸ“¨ Notify Discord
        env:
          # âš ï¸  Store your webhook URL in:
          #     Settings â†’ Secrets and variables â†’ Actions
          #     Secret name: DISCORD_WEBHOOK
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

          # Expose GitHub context as env vars for the script
          GH_ACTOR:    ${{ github.actor }}
          GH_REPO:     ${{ github.repository }}
          GH_BRANCH:   ${{ github.ref_name }}
          GH_SHA:      ${{ github.sha }}
          GH_MSG:      ${{ github.event.head_commit.message }}
          GH_REPO_URL: ${{ github.server_url }}/${{ github.repository }}

        run: |
          python3 - <<'EOF'
          import os
          import json
          import urllib.request
          import urllib.error

          # â”€â”€ Read environment variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          webhook_url = os.environ["DISCORD_WEBHOOK"]
          actor       = os.environ["GH_ACTOR"]
          repo        = os.environ["GH_REPO"]
          branch      = os.environ["GH_BRANCH"]
          sha         = os.environ["GH_SHA"]
          commit_msg  = os.environ["GH_MSG"]
          repo_url    = os.environ["GH_REPO_URL"]

          short_sha   = sha[:7]   # First 7 chars â€” standard convention
          commit_url  = f"{repo_url}/commit/{sha}"
          actor_url   = f"https://github.com/{actor}"
          avatar_url  = f"https://github.com/{actor}.png?size=128"

          # â”€â”€ Build the Discord Embed payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Discord embeds let us create rich, structured cards.
          payload = {
            "content": "ğŸ‘‹ **Hello World!** A new push just landed.",
            "embeds": [
              {
                "title": f"ğŸ“¦ New Push to `{repo}`",
                "url": commit_url,
                "color": 0x5865F2,   # Discord Blurple
                "author": {
                  "name": actor,
                  "url": actor_url,
                  "icon_url": avatar_url
                },
                "fields": [
                  {
                    "name": "ğŸ‘¤ Pushed by",
                    "value": f"[{actor}]({actor_url})",
                    "inline": True
                  },
                  {
                    "name": "ğŸŒ¿ Branch",
                    "value": f"`{branch}`",
                    "inline": True
                  },
                  {
                    "name": "ğŸ”– Commit",
                    "value": f"[`{short_sha}`]({commit_url})",
                    "inline": True
                  },
                  {
                    "name": "ğŸ’¬ Commit Message",
                    "value": commit_msg or "_No message provided_",
                    "inline": False
                  }
                ],
                "footer": {
                  "text": "GitHub Actions Ã— Discord PoC â€” RUXAILAB GSoC 2026"
                },
                "thumbnail": {
                  "url": avatar_url
                }
              }
            ]
          }

          # â”€â”€ Send the HTTP POST request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          body = json.dumps(payload).encode("utf-8")
          req  = urllib.request.Request(
              webhook_url,
              data    = body,
              headers = {"Content-Type": "application/json"},
              method  = "POST"
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  print(f"âœ… Discord notified â€” HTTP {resp.status}")
          except urllib.error.HTTPError as e:
              print(f"âŒ Failed to notify Discord â€” HTTP {e.code}: {e.reason}")
              raise SystemExit(1)   # Fail the step so the Action shows red
          EOF
